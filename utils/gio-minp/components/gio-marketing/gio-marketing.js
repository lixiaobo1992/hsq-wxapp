"use strict";gioGlobal.__growing__||console.error("未加载 gio SDK");const gio=gioGlobal.__growing__.gio,growingio=gioGlobal.__growing__.growingio,gioEmitter=gioGlobal.__growing__.gioEmitter,userStorage=gioGlobal.__growing__.userStorage;function getParameterByName(e,t){if("string"!=typeof t)return;"?"!==t[0]&&(t="?"+t),e=e.replace(/[\[\]]/g,"\\$&");const s=RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return s?s[2]?decodeURIComponent(s[2].replace(/\+/g," ")):"":null}!growingio.marketingHost&&(growingio.marketingHost="https://messages.growingio.com");class StatusStorage{constructor(e){this.namespace=e}_getOldkey(e){return"#"+this.namespace+"#"+e}_key(e,t=""){return"#"+this.namespace+"#"+e+"_"+t}_get(e,t){const s=this._getOldkey(e),i=wx.getStorageSync(s);if(i)return wx.removeStorageSync(s),JSON.parse(i);const a=wx.getStorageSync(this._key(e,t));return!!a&&JSON.parse(a)}_set(e,t,s){wx.setStorageSync(this._key(e,t),JSON.stringify(s))}get(e,t){const s=this._get(e,t),i={showTimes:0,showDate:Date.now()};if(s){const a={...i,...s};return this._set(e,t,a),a}return this._set(e,t,i),i}plus(e,t,s,i){const a=this.get(e,t);a[s]=a[s]+i,this._set(e,t,a)}plusShowTimes(e,t,s){this.plus(e,t,"showTimes",s)}plusShowDate(e,t,s){const i=this.get(e,t);i.showDate=Date.now()+s,this._set(e,t,i)}}class Marketing{constructor(){console.log("Marketing 引入成功。请继续使用<gio-marketing />集成在您需要的页面中."),this.isInit=!1,this.statusStorage=new StatusStorage("push-status"),this.timer=null,this.isPreview=!1,this.isRequested=!1,this.isDispatching=!1,this.listener=null,this.fetchedMessages=[],this.renderQueue=[],this.unResolvedEvents=[],this.handleCS1=this.handleCS1.bind(this),this.handleClearCs1=this.handleClearCs1.bind(this),this.handleEvent=this.handleEvent.bind(this),this.addGlobalEventListener()}static getInstance(){return this.marketing||(this.marketing=new Marketing),this.marketing}init(){console.log("gio-marketing 集成成功！初始化中…"),this.isInit=!0,this.addEventListener()}update(){this.refetchPushMessage()}disabled(){this.resetState(),this.setPreviewState(!1)}destroy(){this.disabled(),this.isInit=!1,this.removeEventListener()}addGlobalEventListener(){gioEmitter.on("setCs1",this.handleCS1),gioEmitter.on("clearCs1",this.handleClearCs1)}addEventListener(){gioEmitter.on("appOpen",this.handleEvent),gioEmitter.on("upload",this.handleEvent)}removeEventListener(){gioEmitter.off("appOpen",this.handleEvent),gioEmitter.off("upload",this.handleEvent)}addComponentListener(e){this.listener=e}removeComponentListener(){this.listener=null}resetState(){this.timer=null,this.isRequested=!1,this.isDispatching=!1,this.renderQueue=[],this.clearFetchedMessages(),this.clearUnResolvedEvents()}getPreviewState(){return this.isPreview}setPreviewState(e){this.isPreview=e}gatherUnResolvedEvents(e){this.unResolvedEvents.push(e)}clearUnResolvedEvents(){this.unResolvedEvents=[]}clearFetchedMessages(){this.fetchedMessages=[]}formatUrl(){const e=userStorage.get("bu"),t=userStorage.get("bcs"),s=growingio.info.uid,i=gio("getUserId");let a=`${growingio.marketingHost}/v1/${growingio.vdsConfig.projectId}/notifications?url_scheme=${growingio.vdsConfig.appId}`;return a+=e?`&bu=${e}`:s?`&u=${s}`:"",a+=t?`&bcs=${t}`:i?`&cs=${i}`:""}fetchPushMessage(){const e=this.formatUrl(),t=Date.now();wx.request({url:e,success:e=>{const s=Date.now();userStorage.set("bcs",e.data.idMappings.bcs),userStorage.set("bu",e.data.idMappings.bu),this.fetchedMessages=(e.data.popupWindows||[]).sort((e,t)=>t.updateAt>e.updateAt?1:-1),s-t>5e3&&this.clearUnResolvedEvents(),this.consumeUnResolvedEvents()},fail:()=>{this.clearUnResolvedEvents()},complete:()=>{this.isRequested=!0}})}fetchPreviewPushMessage(e){const t=`${growingio.marketingHost}/v1/${growingio.vdsConfig.projectId}/notifications/preview?url_scheme=${growingio.vdsConfig.appId}&message_id=${e}`;wx.request({url:t,success:e=>{this.triggerListener(e.data.popupWindows[0])}})}refetchPushMessage(){this.isRequested=!1,this.clearFetchedMessages(),this.fetchPushMessage(),this.timer=setTimeout(()=>{this.refetchPushMessage()},18e5)}consumeUnResolvedEvents(e){const t=e=>{if("cstm"===e.t&&!e.n.startsWith("in_app_message_")){const t=this.getValidMessages(e,this.fetchedMessages);t&&t.length&&(this.renderQueue.push(t[0]),this.dispatchMessage())}};if(e)t(e);else for(;this.unResolvedEvents.length>0&&this.fetchedMessages.length>0;){t(this.unResolvedEvents.shift())}}consumeNextMessage(){this.isDispatching=!1,this.dispatchMessage()}dispatchMessage(){if(!this.isDispatching){this.isDispatching=!0;const e=this.renderQueue.shift();this.triggerListener(e)}}triggerListener(e){e&&this.listener&&this.listener(e)}getValidMessages(e,t){const s=userStorage.get("cs1");return t.filter(t=>this.validActionType(t,e)).filter(e=>this.validTimeRange(e)).filter(e=>this.validateTimes(e,s)).filter(e=>this.validateTriggerCd(e,s))}validActionType(e,t){return t.n===e.rule.action}validTimeRange(e){const t=Date.now();return t>=(e.rule.startAt||0)&&(e.rule.endAt||t+1)>t}validateTriggerCd(e,t){return this.statusStorage.get(e.id,t).showDate<Date.now()}validateTimes(e,t){const s=this.statusStorage.get(e.id,t).showTimes;return e.rule.limit>s}onTrackImp(e){if(!this.getPreviewState()){const t=userStorage.get("cs1");gio("track","in_app_message_imp",{in_app_message_name:e.name}),this.statusStorage.plusShowTimes(e.id,t,1),this.statusStorage.plusShowDate(e.id,t,1e3*e.rule.triggerCd)}}onCloseWindow(e){this.getPreviewState()||(gio("track","in_app_message_close",{in_app_message_name:e.name}),this.consumeNextMessage())}onClickTarget(e){if(!this.getPreviewState()){const t=userStorage.get("cs1");gio("track","in_app_message_cmp_click",{in_app_message_name:e.name}),this.statusStorage.plusShowTimes(e.id,t,5e3)}const t=e.contentMetadata.components[0].config.target[`growing.${growingio.vdsConfig.appId}`];t&&this.navigateTo(t)}navigateTo(e){wx.navigateTo({url:e,fail:()=>{wx.switchTab({url:e})}})}handleCS1(e){e!==userStorage.get("cs1")&&(userStorage.set("cs1",e),userStorage.set("bcs",void 0),this.isInit&&this.refetchPushMessage())}handleClearCs1(){userStorage.set("cs1",void 0),userStorage.set("bcs",void 0)}handleEvent(e){if(e)switch(e.t){case"cstm":this.fetchedMessages.length?this.consumeUnResolvedEvents(e):this.isRequested||this.gatherUnResolvedEvents(e);break;case"page":if(!e.q)return;const t=getParameterByName("scene",e.q);if(!t)return;const s=getParameterByName("gioMessageId",t);if(!s)return;this.resetState(),this.setPreviewState(!0),this.fetchPreviewPushMessage(s)}}}const marketing=Marketing.getInstance();Component({data:{message:void 0,visible:!1},attached(){marketing.init(),marketing.addComponentListener(e=>{this.setData({message:e,visible:!0})})},detached(){marketing.destroy(),marketing.removeComponentListener(),this.hideModal()},pageLifetimes:{show(){marketing.update(),gioEmitter.emit("appOpen",{t:"cstm",n:"appOpen"})},hide(){marketing.disabled(),this.hideModal()}},methods:{onClickTarget(){this.hideModal(),marketing.onClickTarget(this.data.message)},onImageLoad(){marketing.onTrackImp(this.data.message)},onImageError(){this.hideModal(),marketing.consumeNextMessage()},handleClose(){this.hideModal(),marketing.onCloseWindow(this.data.message)},handleTouchMove(){},hideModal(){this.setData({visible:!1})}}});
